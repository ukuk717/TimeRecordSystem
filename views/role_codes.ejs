<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ロールコード管理 | Attendly</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <header class="app-header">
    <div class="app-header__brand">
      <h1 class="app-header__title">
        <a href="/admin" class="app-header__home-link">Attendly</a>
      </h1>
      <span class="app-header__role">テナント管理者</span>
    </div>
    <button class="menu-toggle" type="button" aria-label="メニューを開閉" aria-expanded="false">
      <span class="menu-toggle__bar"></span>
      <span class="menu-toggle__bar"></span>
      <span class="menu-toggle__bar"></span>
    </button>
    <nav class="app-header__nav">
      <a href="/admin" class="nav-link">ダッシュボード</a>
      <a href="/admin/payrolls" class="nav-link">給与明細送信</a>
      <a href="/admin/role-codes" class="nav-link">ロールコード管理</a>
      <a href="/password/change" class="nav-link">パスワード変更</a>
      <form method="post" action="/logout" class="nav-form">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <button type="submit" class="btn link">ログアウト</button>
      </form>
    </nav>
  </header>
  <main class="container">
    <% if (flash) { %>
      <div class="flash <%= flash.type %>"><%= flash.message %></div>
    <% } %>

    <% if (generated) { %>
      <section class="card highlight-card">
        <h2>発行したロールコード</h2>
        <dl class="definition-list">
          <div>
            <dt>コード</dt>
            <dd><code class="code-large"><%= generated.code %></code></dd>
          </div>
          <div>
            <dt>共有用URL</dt>
            <dd>
              <% if (generated.shareUrl) { %>
                <div class="share-actions">
                  <a href="<%= generated.shareUrl %>" class="link" target="_blank" rel="noopener noreferrer"><%= generated.shareUrl %></a>
                  <button
                    type="button"
                    class="btn secondary share-button"
                    data-share-url="<%= generated.shareUrl %>"
                    data-role-code="<%= generated.code %>"
                  >
                    共有
                  </button>
                </div>
              <% } else { %>
                発行できませんでした
              <% } %>
            </dd>
          </div>
          <div>
            <dt>有効期限</dt>
            <dd>
              <% if (generated.expiresDisplay) { %>
                <%= generated.expiresDisplay %>
              <% } else { %>
                なし
              <% } %>
            </dd>
          </div>
          <div>
            <dt>使用回数上限</dt>
            <dd><%= Number.isInteger(generated.maxUses) ? generated.maxUses : '無制限' %></dd>
          </div>
        </dl>
        <p class="form-note">従業員にはコードまたは共有用URLを共有し、期限内・上限内に登録してもらってください。</p>
      </section>
    <% } %>

    <section class="card">
      <h2>ロールコードを発行</h2>
      <form method="post" action="/admin/role-codes" class="form form-inline">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <label class="form-field">
          <span>有効期限（任意）</span>
          <input type="datetime-local" name="expiresAt">
        </label>
        <label class="form-field">
          <span>使用回数上限（任意）</span>
          <input type="number" name="maxUses" min="1" max="<%= roleCodeMaxUsesLimit %>">
        </label>
        <button type="submit" class="btn primary">コードを発行</button>
      </form>
      <p class="form-note">
        コードは大文字英数字で生成されます。使用回数上限に到達すると自動的に利用できなくなります。<br>
        無効化したコードは再度有効化できません。
      </p>
    </section>

    <section class="card">
      <h2>発行済みロールコード</h2>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>コード</th>
              <th>共有URL</th>
              <th>状態</th>
              <th>有効期限</th>
              <th>使用状況</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <% if (!codes || codes.length === 0) { %>
              <tr><td colspan="6">まだロールコードが発行されていません。</td></tr>
            <% } else { %>
              <% codes.forEach(function(code) { %>
                <% const limitDisplay = Number.isInteger(code.max_uses) ? code.max_uses : '無制限'; %>
                <tr>
                  <td><code><%= code.code %></code></td>
                  <td>
                    <% if (code.shareUrl) { %>
                      <div class="table-actions share-inline">
                        <a href="<%= code.shareUrl %>" class="link" target="_blank" rel="noopener noreferrer">リンクを開く</a>
                        <button
                          type="button"
                          class="btn secondary share-button"
                          data-share-url="<%= code.shareUrl %>"
                          data-role-code="<%= code.code %>"
                        >
                          共有
                        </button>
                      </div>
                    <% } else { %>
                      <span class="muted">未設定</span>
                    <% } %>
                  </td>
                  <td class="status-cell status-<%= code.status %>">
                    <% if (code.status === 'active') { %>
                      有効
                    <% } else if (code.status === 'expired') { %>
                      期限切れ
                    <% } else if (code.status === 'exhausted') { %>
                      上限到達
                    <% } else { %>
                      無効化済み
                    <% } %>
                  </td>
                  <td><%= code.expiresDisplay || 'なし' %></td>
                  <td><%= code.usage_count %> / <%= limitDisplay %></td>
                  <td>
                    <% if (code.status === 'active') { %>
                      <form
                        method="post"
                        action="/admin/role-codes/<%= code.id %>/disable"
                        class="inline-form"
                        data-confirm-message="ロールコード「<%= code.code %>」を無効化します。この操作は取り消せません。実行しますか？"
                      >
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <button type="submit" class="btn danger">無効化</button>
                      </form>
                    <% } else { %>
                      <span class="muted">操作なし</span>
                    <% } %>
                  </td>
                </tr>
              <% }); %>
            <% } %>
          </tbody>
        </table>
      </div>
    </section>
  </main>
  <div class="dialog-backdrop" id="share-fallback" hidden>
    <div class="dialog">
      <h3>共有URLのコピー</h3>
      <p class="share-dialog-text">以下のボタンを押すとURLをクリップボードにコピーできます。</p>
      <input type="text" class="share-dialog-input" data-share-url-input readonly>
      <p class="share-dialog-status" data-share-status></p>
      <div class="dialog-actions">
        <button type="button" class="btn secondary" data-share-copy>コピー</button>
        <button type="button" class="btn link" data-share-close>閉じる</button>
      </div>
    </div>
  </div>
  <script src="/header.js" defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const shareButtons = document.querySelectorAll('.share-button');
      if (!shareButtons.length) {
        return;
      }

      const shareTitle = 'Attendly ロールコード共有';

      const fallbackDialog = (() => {
        const backdrop = document.getElementById('share-fallback');
        if (!backdrop) {
          return null;
        }
        const input = backdrop.querySelector('[data-share-url-input]');
        const status = backdrop.querySelector('[data-share-status]');
        const copyButton = backdrop.querySelector('[data-share-copy]');
        const closeButton = backdrop.querySelector('[data-share-close]');

        const setStatus = (message, type) => {
          if (!status) {
            return;
          }
          status.textContent = message || '';
          status.classList.remove('success', 'error');
          if (type === 'success') {
            status.classList.add('success');
          } else if (type === 'error') {
            status.classList.add('error');
          }
        };

        const hide = () => {
          backdrop.setAttribute('hidden', '');
          if (input) {
            input.value = '';
          }
          setStatus('', null);
        };

        const copyToClipboard = async () => {
          if (!input) {
            return;
          }
          input.select();
          input.setSelectionRange(0, input.value.length);
          try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(input.value);
            } else if (document.execCommand) {
              const succeeded = document.execCommand('copy');
              if (!succeeded) {
                throw new Error('copy command failed');
              }
            } else {
              throw new Error('no clipboard API');
            }
            setStatus('コピーしました。', 'success');
          } catch (error) {
            setStatus('コピーに失敗しました。', 'error');
          }
        };

        if (copyButton) {
          copyButton.addEventListener('click', copyToClipboard);
        }
        if (closeButton) {
          closeButton.addEventListener('click', hide);
        }
        backdrop.addEventListener('click', (event) => {
          if (event.target === backdrop) {
            hide();
          }
        });

        return {
          show: (url) => {
            if (!input) {
              return;
            }
            input.value = url;
            setStatus('', null);
            backdrop.removeAttribute('hidden');
            window.requestAnimationFrame(() => {
              input.focus();
              input.select();
            });
          },
          hide,
        };
      })();

      const fallbackShare = async (url) => {
        if (!url) {
          return;
        }
        if (navigator.clipboard && navigator.clipboard.writeText) {
          try {
            await navigator.clipboard.writeText(url);
            window.alert('共有URLをクリップボードにコピーしました。');
            return;
          } catch (error) {
            // 続行して手動コピーUIを表示
          }
        }
        if (fallbackDialog) {
          fallbackDialog.show(url);
          return;
        }
        window.prompt('以下のURLをコピーして共有してください:', url);
      };

      const handleShare = async (event) => {
        const button = event.currentTarget;
        const shareUrl = button.getAttribute('data-share-url');
        const roleCode = button.getAttribute('data-role-code') || '';
        if (!shareUrl) {
          return;
        }

        const shareData = {
          title: shareTitle,
          url: shareUrl,
        };
        if (roleCode) {
          shareData.text = `ロールコード: ${roleCode}`;
        }

        if (navigator.share) {
          try {
            await navigator.share(shareData);
            return;
          } catch (error) {
            if (error && error.name === 'AbortError') {
              return;
            }
            // fall through to clipboard prompt
          }
        }

        await fallbackShare(shareUrl);
      };

      shareButtons.forEach((button) => {
        button.addEventListener('click', handleShare);
      });
    });
  </script>
</body>
</html>
